#define FONT_LM80C

#define BIN_TYPE BIN_CPM

#include "../../NABULIB/NABU-LIB.h"
#include <stdlib.h>
#include <stdbool.h>
#include <arch/z80.h>

const uint8_t face[32] = {
    0x07, 0x1F, 0x3F, 0x67, 0x67, 0xFF, 0xFF, 0xFF,
    0xDF, 0xCF, 0xC3, 0x60, 0x70, 0x3C, 0x1F, 0x07,
    0xE0, 0xF8, 0xFC, 0xE6, 0xE6, 0xFF, 0xFF, 0xFF,
    0xFB, 0xF3, 0xC3, 0x06, 0x0E, 0x3C, 0xF8, 0xE0};

const uint8_t virus[32] = {
    0x01, 0x08, 0x10, 0x29, 0x07, 0x07, 0x4F, 0x7F,
    0x4F, 0x07, 0x07, 0x29, 0x10, 0x08, 0x01, 0x00,
    0xC0, 0x88, 0x84, 0xCA, 0xF0, 0xF0, 0xF9, 0xFF,
    0xF9, 0xF0, 0xF0, 0xCA, 0x84, 0x88, 0xC0, 0x00};

const uint8_t rocket[32] = {
    0x00, 0x00, 0x70, 0xFC, 0x3F, 0xFF, 0x7F, 0x7F,
    0x7F, 0xFF, 0x3F, 0xFF, 0x7C, 0x70, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFC, 0xFE,
    0xFE, 0xFC, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00};

const uint8_t monster[32] = {
    0x04, 0x0C, 0x1F, 0x3F, 0x7F, 0xE3, 0xFF, 0xFF,
    0xFF, 0xF8, 0xF5, 0xED, 0xFF, 0x7F, 0x3F, 0x00,
    0x20, 0x30, 0xF8, 0xFC, 0xFE, 0xC7, 0xFF, 0xFF,
    0xFF, 0x0F, 0xD7, 0xDB, 0xFF, 0xFE, 0xFC, 0x00};

const uint8_t heart[32] = {
    0x00, 0x0C, 0x1C, 0x3E, 0x7E, 0x7F, 0x7F, 0x7F,
    0x7F, 0x3F, 0x1F, 0x0F, 0x07, 0x03, 0x01, 0x00,
    0x00, 0x18, 0x1C, 0x3E, 0x3F, 0x7F, 0xFF, 0xFF,
    0xFF, 0xFE, 0xFC, 0xF8, 0xF0, 0xE0, 0xC0, 0x80};

const uint8_t like[32] = {
    0x01, 0x01, 0x01, 0x03, 0x03, 0x07, 0x0F, 0x1F,
    0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFF,
    0x00, 0x80, 0x80, 0x80, 0x80, 0xFE, 0xFE, 0xF8,
    0xFF, 0xFF, 0xF8, 0xFF, 0xFF, 0xF8, 0xFE, 0xFE};

const uint8_t bell[32] = {
    0x01, 0x07, 0x1F, 0x3F, 0x3F, 0x7F, 0x7F, 0x7F,
    0x7F, 0x7F, 0x7F, 0xFF, 0xFF, 0x03, 0x03, 0x01,
    0x80, 0xE0, 0xF8, 0xFC, 0xFC, 0xFE, 0xFE, 0xFE,
    0xFE, 0xFE, 0xFE, 0xFF, 0xFF, 0xE0, 0xE0, 0xC0};

const uint8_t finger[32] = {
    0x06, 0x06, 0x07, 0x07, 0x07, 0x67, 0x77, 0x3F,
    0x1F, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xC0, 0xF8, 0xFC, 0xFC, 0xFC, 0xFC,
    0xFC, 0xFC, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00};

const uint8_t fish[32] = {
    0x00, 0x00, 0x00, 0x03, 0x07, 0x0F, 0x9F, 0xDF,
    0xFF, 0xFF, 0xDF, 0x8F, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x40, 0xF0, 0xF8, 0xEC, 0xFE, 0xFF,
    0xBE, 0xDE, 0xE4, 0xFC, 0xF8, 0x00, 0x00, 0x00};

const int xmax = 270;
const int xmin = 16;
const int ymin = 5;
const int ymax = 170;

uint16_t yPos = 5;
bool     yDir = true;

uint16_t xPos = 5;
bool     xDir = true;

uint16_t sprite_names[32] = { 0 };

void move(uint8_t id) {

  uint16_t handle = sprite_names[id];

  vdp_setSpritePosition(handle, xPos, yPos);
}

void main() {

  initNABULib();
  
  vdp_initG2Mode(true, false);

  vdp_setSpritePattern(0, face);
  vdp_setSpritePattern(1, virus);
  vdp_setSpritePattern(2, rocket);
  vdp_setSpritePattern(3, monster);
  vdp_setSpritePattern(4, finger);
  vdp_setSpritePattern(5, like);
  vdp_setSpritePattern(6, bell);
  vdp_setSpritePattern(7, heart);
  vdp_setSpritePattern(8, fish);

  for (uint8_t i = 0; i < 9; i++) {

    sprite_names[i] = vdp_spriteInit(i, i, 0);

    vdp_setSpriteColor(sprite_names[i], 3);
  }

  while (true) {

    move(0);

    if (yDir)
      yPos++;
    else 
      yPos--;

    if (yPos > ymax)
      yDir = false;
    else if (yPos < ymin)
      yDir = true;

    if (xDir)
      xPos++;
    else 
      xPos--;

    if (xPos > xmax)
      xDir = false;
    else if (xPos < xmin)
      xDir = true;

    if (isKeyPressed())
      return;

    z80_delay_ms(25);
  }  
}
